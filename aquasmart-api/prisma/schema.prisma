generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ===== Núcleo de usuarios / personas / permisos =====

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  active       Boolean  @default(true)
  passwordHash String
  person       Person?
  pools        Pool[]
  historiales  Historial[]
  acciones     AccionCorrectiva[]
  groups       UserGroup[]
  createdAt    DateTime @default(now())
  auditLogs    AuditLog[]

}

model Person {
  id     String @id @default(cuid())
  name   String
  email  String @unique
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])
}

model Group {
  id    String            @id @default(cuid())
  name  String            @unique
  desc  String?
  users UserGroup[]
  perms GroupPermission[]
}

model Permission {
  id     String            @id @default(cuid())
  code   String            @unique
  desc   String?
  groups GroupPermission[]
}


model UserGroup {
  userId  String
  groupId String
  user    User   @relation(fields: [userId], references: [id])
  group   Group  @relation(fields: [groupId], references: [id])

  @@id([userId, groupId])
}

model GroupPermission {
  groupId      String
  permissionId String
  group        Group      @relation(fields: [groupId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([groupId, permissionId])
}

// ===== Dominio AquaSmart =====

model Pool {
  id        String   @id @default(cuid())
  name      String
  ownerId   String?
  owner     User?    @relation(fields: [ownerId], references: [id])
  createdAt DateTime @default(now())

  // ==== Campos físicos según tu UML de Pileta ====
  volumen             Float?   // m3 aproximados
  largo               Float?   // metros
  ancho               Float?   // metros
  profundidadPromedio Float?   // metros
  estadoPileta        String?  @default("OK") // ej: OK, En_Mantenimiento, Cerrada

  // ==== Relaciones ya existentes ====
  sensoresLectura SensorLectura[]
  threshold       Threshold?
  alerts          Alert[]
  acciones        AccionCorrectiva[]
  historiales     Historial[]
  auditLogs      AuditLog[]   

}


model SensorLectura {
  id         String     @id @default(cuid())
  poolId     String
  pool       Pool       @relation(fields: [poolId], references: [id])
  fechaHora  DateTime   @default(now())
  parametros Parametro[]
}

model Parametro {
  id         String         @id @default(cuid())
  lecturaId  String
  lectura    SensorLectura  @relation(fields: [lecturaId], references: [id])
  tipo       String
  unidad     String
  valor      Float
}

model Threshold {
  id        String   @id @default(cuid())
  poolId    String   @unique
  pool      Pool     @relation(fields: [poolId], references: [id])

  phMin     Float    @default(7.2)
  phMax     Float    @default(7.8)
  chlorMin  Float    @default(0.5)
  chlorMax  Float    @default(1.5)
  tempMin   Float    @default(20)
  tempMax   Float    @default(35)

  // Mejoras
  estadoUmbral   String?   @default("OK")
  notas          String?
  modificadoPor  String?
  version        Int?      @default(1)

  updatedAt DateTime @updatedAt
}


model AccionCorrectiva {
  id              String     @id @default(cuid())
  alertaId        String   @unique
  poolId          String
  descripcion     String
  tipoAccion      String
  fechaCorreccion DateTime  @default(now())
  userId          String?

  alerta          Alert      @relation("AccionPorAlerta", fields: [alertaId], references: [id])
  pool            Pool       @relation(fields: [poolId], references: [id])
  historial       Historial[]
  user            User?      @relation(fields: [userId], references: [id])
}


model Alert {
  id               String             @id @default(cuid())
  poolId           String
  pool             Pool              @relation(fields: [poolId], references: [id])
  type             String
  message          String
  level            String
  createdAt        DateTime          @default(now())
  resolvedAt       DateTime?
  accionCorrectiva AccionCorrectiva? @relation("AccionPorAlerta")

}

model Historial {
  id        String             @id @default(cuid())
  resumen   String
  fecha     DateTime           @default(now())
  accionId  String
  accion    AccionCorrectiva   @relation(fields: [accionId], references: [id])
  poolId    String?
  pool      Pool?              @relation(fields: [poolId], references: [id])
  userId    String?
  user      User?              @relation(fields: [userId], references: [id])
}


model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  action    String
  module    String
  detail    String

  poolId    String?
  pool      Pool?    @relation(fields: [poolId], references: [id])

  fechaHora DateTime @default(now())
}
